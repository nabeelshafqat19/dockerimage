trigger:
- main

variables:
  dockerId: "kokoopoli"  # Exact Docker Hub username
  imageRepository: "todolist-app"  # Exact repo name
  tag: "$(Build.BuildId)"

stages:
- stage: BuildAndPush
  jobs:
  - job: DockerJob
    pool: todopull
    steps:
    - task: Docker@2
      displayName: Login to Docker Hub
      inputs:
        command: login
        containerRegistry: "dockerhub-service"  # Using access token

    - task: Docker@2
      displayName: Build and Push
      inputs:
        command: buildAndPush
        repository: $(dockerId)/$(imageRepository)
        dockerfile: "Dockerfile"
        containerRegistry: "dockerhub-service"
        tags: $(tag)
      env:
        DOCKER_BUILDKIT: 1  # Enable modern build features